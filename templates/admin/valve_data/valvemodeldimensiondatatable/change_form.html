{% extends "admin/change_form.html" %}
{% load i18n admin_urls static %}

{% block extrahead %}
{{ block.super }}
<script src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
<script src="{% static 'admin/js/jquery.init.js' %}"></script>
{% endblock %}

{% block content %}
<div id="content-main">
    {{ block.super }}  {# –≠—Ç–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç –æ—Å–Ω–æ–≤–Ω—É—é —Ñ–æ—Ä–º—É Django admin #}
    
    {# –ù–ê–®–ê –§–û–†–ú–ê –ò–ú–ü–û–†–¢–ê - –ü–û–°–õ–ï –û–°–ù–û–í–ù–û–ô –§–û–†–ú–´ #}
    {% if original and original.pk %}
    <div class="module" style="margin-top: 20px; background: #f8f8f8; padding: 20px; border: 1px solid #ddd;">
        <h2>{% trans "–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –í–ì–•" %}</h2>
        
        <div style="margin: 15px 0;">
            <form id="dimension-import-form" method="post" enctype="multipart/form-data" 
                  action="{% url 'admin:dimension_table_import' original.pk %}">
                {% csrf_token %}
                <div style="margin-bottom: 15px;">
                    <label for="excel_file" style="font-weight: bold; display: block; margin-bottom: 5px;">
                        {% trans "–í—ã–±–µ—Ä–∏—Ç–µ Excel —Ñ–∞–π–ª:" %}
                    </label>
                    <input type="file" name="excel_file" id="excel_file" accept=".xlsx,.xls" required 
                           style="padding: 5px; border: 1px solid #ccc; border-radius: 3px;">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <button type="submit" class="button" 
                            style="background: #417690; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer; font-size: 14px;">
                        üìä {% trans "–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–∑ Excel" %}
                    </button>
                    <a href="{% url 'admin:dimension_table_export_template' original.pk %}" class="button" 
                       style="background: #999; color: white; padding: 10px 20px; text-decoration: none; border-radius: 3px; margin-left: 10px; display: inline-block; font-size: 14px;">
                        üì• {% trans "–°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω" %}
                    </a>
                </div>
            </form>
        </div>

        <div style="background: #fff; padding: 15px; border: 1px solid #ccc; border-radius: 3px;">
            <h3>{% trans "–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ —Ñ–∞–π–ª—É:" %}</h3>
            <ul style="margin: 10px 0; padding-left: 20px;">
                <li>{% trans "–ü–µ—Ä–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –Ω–∞–∑–≤–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤" %}</li>
                <li>{% trans "–ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–ª–æ–Ω–∫–∏ - –∑–Ω–∞—á–µ–Ω–∏—è DN (–Ω–∞–ø—Ä–∏–º–µ—Ä: DN50, DN65, DN80)" %}</li>
                <li>{% trans "–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: .xlsx, .xls" %}</li>
                <li>{% trans "–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã" %}</li>
            </ul>
        </div>
    </div>
    {% else %}
    <div class="module" style="margin-top: 20px; background: #fff3cd; padding: 20px; border: 1px solid #ffeaa7;">
        <h2>{% trans "–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –í–ì–•" %}</h2>
        <p>{% trans "–§—É–Ω–∫—Ü–∏–∏ –∏–º–ø–æ—Ä—Ç–∞ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã." %}</p>
    </div>
    {% endif %}
</div>

<script>
(function($) {
    $(document).ready(function() {
        console.log("=== DEBUG: Page loaded ===");
        
        const importForm = document.getElementById('dimension-import-form');
        if (importForm) {
            console.log("=== DEBUG: Import form found ===");
            console.log("Import form action:", importForm.action);
            console.log("Import form parent:", importForm.parentElement);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–æ—Ä–º–∞ –ù–ï –≤–Ω—É—Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ—Ä–º—ã
            const mainForm = document.getElementById('valvemodeldimensiondatatable_form');
            if (mainForm && mainForm.contains(importForm)) {
                console.log("ERROR: Import form is INSIDE main form!");
            } else {
                console.log("SUCCESS: Import form is OUTSIDE main form!");
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∏–º–ø–æ—Ä—Ç–∞
            $('#dimension-import-form').on('submit', function(e) {
                console.log("=== DEBUG: Import form submitted ===");
                console.log("Submitting to:", this.action);
                
                var fileInput = $('#excel_file')[0];
                if (!fileInput.files.length) {
                    alert('{% trans "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª" %}');
                    e.preventDefault();
                    return;
                }
                
                var submitBtn = $(this).find('button[type="submit"]');
                submitBtn.prop('disabled', true).text('{% trans "–ò–º–ø–æ—Ä—Ç..." %}');
            });
        } else {
            console.log("=== DEBUG: Import form NOT found ===");
        }
        
        $('#excel_file').on('change', function() {
            var fileName = $(this).val().split('\\').pop();
            if (fileName) {
                $(this).next('.file-info').remove();
                $(this).after('<span class="file-info" style="margin-left: 10px; color: #666;">' + fileName + '</span>');
            }
        });
    });
})(django.jQuery);
</script>
{% endblock %}